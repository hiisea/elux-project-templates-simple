import {BaseModel, effect, reducer, isServer, LoadingState} from '@elux/<%= elux %>';
import {CustomError, CommonErrorCode} from '@/utils/errors';
import {GetRouter} from '@/Global';
import {CurUser, SubView, LoginParams, api} from './entity';

export interface ModuleState {
  loading?: {global: LoadingState};
  curUser: CurUser;
}

export interface ModuleRouteParams {
  subView: SubView;
}

export class Model extends BaseModel<ModuleState, ModuleRouteParams> {
  defaultRouteParams: ModuleRouteParams = {
    subView: '',
  };

  init(latestData: {[moduleName: string]: any}, ssrData: {[moduleName: string]: any}): ModuleState {
    return (
      latestData[this.moduleName] || {
        curUser: {
          id: '',
          username: '游客',
          avatar: '',
          mobile: '',
          hasLogin: undefined,
        },
      }
    );
  }

  @reducer
  public putCurUser(curUser: CurUser): <%= framework ==='reactRedux'?'ModuleState':'void' %> {
  <%_ if(framework ==='reactRedux'){ -%>
    return {...this.getState(), curUser};
  <%_ }else{ -%>
    Object.assign(this.getState(), {curUser});
  <%_ } -%>
  }

  @effect()
  public async login(args: LoginParams): Promise<void> {
    const curUser = await api.login(args);
    this.dispatch(this.actions.putCurUser(curUser));
    GetRouter().relaunch('/index');
  }

  @effect()
  public async logout(): Promise<void> {
    const curUser = await api.logout();
    this.dispatch(this.actions.putCurUser(curUser));
    GetRouter().relaunch('/login');
  }

  @effect(null)
  protected async ['Elux.Error'](error: CustomError): Promise<void> {
    //注意错误处理中不要抛出新的错误，以防止无穷递归
    if (error.code === CommonErrorCode.unauthorized) {
      GetRouter().push('/login', true, true);
    } else if (!error.quiet) {
      // eslint-disable-next-line no-alert
<% if (platform==='ssr') { -%>
      typeof window === 'object' && window.alert(error.message);
<% } else { -%>
      window.alert(error.message);
<% } -%>
    }
    throw error;
  }

  // 支持路由守卫
  @effect(null)
  protected async ['route.RouteTestChange']({pagename}: {pagename: string}): Promise<void> {
    if (pagename === '/my' && !this.getState().curUser.hasLogin) {
      throw new CustomError(CommonErrorCode.unauthorized, '请登录！', null, true);
    }
  }

  @effect(null)
  protected async ['this.Init'](initState: ModuleState): Promise<void> {
    if (initState.curUser.hasLogin === undefined && !isServer()) {
      //也可以将用户身份作为前置依赖: const curUser = await api.getCurUser();
      api.getCurUser().then((curUser) => this.dispatch(this.actions.putCurUser(curUser)));
    }
  }
}
